<main
  style="padding:var(--space-md); flex: 1; display: flex; flex-direction: column; overflow: hidden; box-sizing: border-box;"
>
  @if (stars().length > 0) {
    <section
      style="border:1px solid #ccc; position: relative; flex-grow: 1; overflow: hidden; touch-action: none;"
      (mousedown)="onMouseDown($event)"
      (mousemove)="onMouseMove($event)"
      (mouseup)="onMouseUp()"
      (mouseleave)="onMouseUp()"
      (touchstart)="onTouchStart($event)"
      (touchmove)="onTouchMove($event)"
      (touchend)="onTouchEnd()"
      (wheel)="onWheel($event)"
      (click)="menus.closeMenus()"
    >
      <svg
        #galaxySvg
        [attr.viewBox]="'0 0 ' + width() + ' ' + height()"
        preserveAspectRatio="xMidYMid meet"
        style="width:100%;height:100%;touch-action:none;background:#02030a"
        (contextmenu)="menus.handleMapRightClick($event)"
      >
        <defs>
          <radialGradient id="galaxyBgGradient" cx="50%" cy="50%" r="80%">
            <stop offset="0%" stop-color="#0b1030"></stop>
            <stop offset="45%" stop-color="#05081a"></stop>
            <stop offset="100%" stop-color="#02030a"></stop>
          </radialGradient>
          <filter id="galaxyNoise" x="-20%" y="-20%" width="140%" height="140%">
            <feTurbulence
              type="fractalNoise"
              baseFrequency="0.8"
              numOctaves="3"
              seed="7"
              result="noise"
            ></feTurbulence>
            <feColorMatrix
              in="noise"
              type="matrix"
              values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.15 0"
              result="noiseAlpha"
            ></feColorMatrix>
            <feComposite in="noiseAlpha" in2="SourceGraphic" operator="over"></feComposite>
          </filter>
          <filter id="galaxyNebulaBlur" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="18"></feGaussianBlur>
          </filter>
        </defs>

        <g #worldGroup [attr.transform]="state.transformString()">
          <!-- Background Layer -->
          <rect
            x="0"
            y="0"
            [attr.width]="width()"
            [attr.height]="height()"
            fill="url(#galaxyBgGradient)"
          ></rect>
          <rect
            x="0"
            y="0"
            [attr.width]="width()"
            [attr.height]="height()"
            filter="url(#galaxyNoise)"
            opacity="0.55"
          ></rect>

          <!-- Nebulae -->
          <g style="mix-blend-mode: screen; opacity: 0.9;">
            <circle
              [attr.cx]="width() * 0.25"
              [attr.cy]="height() * 0.26"
              [attr.r]="width() * 0.12"
              fill="#2b3bff"
              opacity="0.08"
              filter="url(#galaxyNebulaBlur)"
            ></circle>
            <circle
              [attr.cx]="width() * 0.8"
              [attr.cy]="height() * 0.4"
              [attr.r]="width() * 0.16"
              fill="#ff2bd6"
              opacity="0.05"
              filter="url(#galaxyNebulaBlur)"
            ></circle>
            <circle
              [attr.cx]="width() * 0.6"
              [attr.cy]="height() * 0.75"
              [attr.r]="width() * 0.14"
              fill="#2bffd5"
              opacity="0.04"
              filter="url(#galaxyNebulaBlur)"
            ></circle>
          </g>

          <!-- Scanner Ranges -->
          @if (settings.showScannerRanges()) {
            @for (range of visibility.scannerRanges(); track $index) {
              <circle
                [attr.cx]="range.x"
                [attr.cy]="range.y"
                [attr.r]="range.r"
                fill="rgba(52, 152, 219, 0.1)"
                stroke="#3498db"
                stroke-width="1"
                style="pointer-events: none"
              />
            }
          }

          <!-- Cloaked Ranges -->
          @if (settings.showCloakedRanges()) {
            @for (range of visibility.cloakedRanges(); track $index) {
              <circle
                [attr.cx]="range.x"
                [attr.cy]="range.y"
                [attr.r]="range.r"
                fill="none"
                stroke="#9b59b6"
                stroke-width="1"
                stroke-dasharray="4,4"
                style="pointer-events: none"
              />
            }
          }

          <!-- Fleet Waypoints -->
          @for (fw of fleetWaypoints(); track fw.fleetId) {
            @if (fw.segments.length > 0) {
              <g
                class="waypoints"
                [style.opacity]="navigationModeFleetId() === fw.fleetId ? 1 : 0.4"
              >
                @for (seg of fw.segments; track $index) {
                  <line
                    [attr.x1]="seg.x1"
                    [attr.y1]="seg.y1"
                    [attr.x2]="seg.x2"
                    [attr.y2]="seg.y2"
                    stroke="#2ecc71"
                    stroke-width="1"
                    stroke-dasharray="4,4"
                    style="pointer-events: none;"
                  />
                  <circle
                    [attr.cx]="seg.x2"
                    [attr.cy]="seg.y2"
                    r="4"
                    fill="#2ecc71"
                    stroke="#000"
                    stroke-width="0.5"
                    (mousedown)="onWaypointDown($event, fw.fleetId, $index)"
                    (touchstart)="onWaypointDown($event, fw.fleetId, $index)"
                    (click)="onWaypointClick($event, fw.fleetId, seg.order)"
                    style="cursor: pointer"
                  />
                }
              </g>
            }
          }

          <!-- Draw fleets first so stars remain clickable on top -->
          @for (fleet of fleetFilter.filteredFleets(); track fleet.id) {
            @if (fleet.location.type === 'orbit') {
              @if (fleetPositions.fleetOrbitPosition(fleet); as pos) {
                <g
                  app-galaxy-fleet
                  [fleet]="fleet"
                  [position]="pos"
                  [isOrbit]="true"
                  (fleetClick)="onFleetClick(fleet, $event)"
                  (fleetDoubleClick)="onFleetDoubleClick(fleet, $event)"
                  (fleetContext)="onFleetRightClick($event, fleet)"
                  (fleetDown)="onFleetDown($event, fleet)"
                ></g>
              }
            } @else {
              <!-- Space fleet -->
              <g
                app-galaxy-fleet
                [fleet]="fleet"
                [position]="fleetPositions.getSpaceFleetPos(fleet)"
                [isOrbit]="false"
                (fleetClick)="onFleetClick(fleet, $event)"
                (fleetDoubleClick)="onFleetDoubleClick(fleet, $event)"
                (fleetContext)="onFleetRightClick($event, fleet)"
                (fleetDown)="onFleetDown($event, fleet)"
              ></g>
            }
          }

          @if (selectedFleet(); as fleet) {
            @if (fleetPositions.getFleetPosition(fleet); as pos) {
              @if (visibility.getFleetScanCapabilities(fleet); as caps) {
                @if (caps.scanRange > 0) {
                  <circle
                    [attr.cx]="pos.x"
                    [attr.cy]="pos.y"
                    [attr.r]="caps.scanRange"
                    fill="rgba(52, 152, 219, 0.1)"
                    stroke="#3498db"
                    stroke-dasharray="4,3"
                    [attr.stroke-width]="2"
                    style="pointer-events: none"
                  />
                }
                @if (caps.cloakedRange > 0) {
                  <circle
                    [attr.cx]="pos.x"
                    [attr.cy]="pos.y"
                    [attr.r]="caps.cloakedRange"
                    fill="none"
                    stroke="#9b59b6"
                    stroke-dasharray="4,3"
                    [attr.stroke-width]="1"
                    style="pointer-events: none"
                  />
                }
              }
            }
          }

          <!-- Draw stars on top for clear selection -->
          @for (star of stars(); track star.id) {
            <g
              app-galaxy-star
              [star]="star"
              [scale]="state.scale()"
              [visibility]="starVisibilityMap().get(star.id) || { status: 'unexplored', age: 0 }"
              [viewMode]="settings.viewMode()"
              [showLabels]="settings.showLabels()"
              [stationName]="fleetStations.stationByStarId().get(star.id)"
              (starClick)="onStarClick(star, $event)"
              (starDoubleClick)="onStarDoubleClick(star, $event)"
              (starContext)="onStarRightClick($event, star)"
            ></g>
          }

          @if (selectedStar() && state.selectedFleetId(); as fid) {
            @if (fleetPositions.pathMarkers(fid, selectedStar()!); as marks) {
              <line
                [attr.x1]="fleetPositions.fleetPos(fid).x"
                [attr.y1]="fleetPositions.fleetPos(fid).y"
                [attr.x2]="selectedStar()!.position.x"
                [attr.y2]="selectedStar()!.position.y"
                stroke="#34495e"
                stroke-dasharray="4,3"
                [attr.stroke-width]="1"
                style="pointer-events:none"
              />
              @for (m of marks; track $index) {
                <circle
                  [attr.cx]="m.x"
                  [attr.cy]="m.y"
                  [attr.r]="3"
                  fill="#34495e"
                  style="pointer-events:none"
                />
              }
            }
          }

          @for (fleet of fleetWaypoints(); track fleet.fleetId) {
            @for (seg of fleet.segments; track $index) {
              @if (
                draggedWaypoint()?.fleetId !== fleet.fleetId ||
                draggedWaypoint()?.orderIndex !== $index
              ) {
                <line
                  [attr.x1]="seg.x1"
                  [attr.y1]="seg.y1"
                  [attr.x2]="seg.x2"
                  [attr.y2]="seg.y2"
                  [attr.stroke]="seg.color"
                  stroke-width="2"
                  stroke-dasharray="4"
                  style="pointer-events: none;"
                />
                @if (seg.distance > 0) {
                  <text
                    [attr.x]="(seg.x1 + seg.x2) / 2"
                    [attr.y]="(seg.y1 + seg.y2) / 2"
                    fill="white"
                    font-size="10"
                    text-anchor="middle"
                    dy="-5"
                    style="pointer-events: none; text-shadow: 1px 1px 1px #000;"
                  >
                    {{ seg.distance }} ly
                  </text>
                }
                @if (seg.warning) {
                  <text
                    [attr.x]="(seg.x1 + seg.x2) / 2"
                    [attr.y]="(seg.y1 + seg.y2) / 2"
                    fill="#e74c3c"
                    font-size="12"
                    text-anchor="middle"
                    dy="10"
                    style="pointer-events: none; font-weight: bold; text-shadow: 1px 1px 1px #000;"
                  >
                    !!
                  </text>
                }
                <circle
                  [attr.cx]="seg.x2"
                  [attr.cy]="seg.y2"
                  r="5"
                  [attr.fill]="seg.color"
                  stroke="#fff"
                  stroke-width="1"
                  class="waypoint-marker"
                  style="pointer-events: auto; cursor: context-menu;"
                  (contextmenu)="onWaypointRightClick($event, fleet.fleetId, $index)"
                  (touchstart)="onWaypointTouchStart($event, fleet.fleetId, $index)"
                  (touchend)="onWaypointTouchEnd()"
                />
              }
            }
          }

          @if (draggedWaypoint()) {
            <line
              [attr.x1]="draggedWaypoint()!.startX"
              [attr.y1]="draggedWaypoint()!.startY"
              [attr.x2]="draggedWaypoint()!.currentX"
              [attr.y2]="draggedWaypoint()!.currentY"
              stroke="#2ecc71"
              stroke-width="2"
              stroke-dasharray="5,5"
              style="pointer-events: none;"
            />
            <circle
              [attr.cx]="draggedWaypoint()!.currentX"
              [attr.cy]="draggedWaypoint()!.currentY"
              r="5"
              fill="#2ecc71"
              stroke="#fff"
              stroke-width="1"
              style="pointer-events: none;"
            />
            @if (snapTarget()) {
              <circle
                [attr.cx]="snapTarget()!.x"
                [attr.cy]="snapTarget()!.y"
                r="15"
                fill="none"
                stroke="#e74c3c"
                stroke-width="2"
                style="pointer-events: none;"
              />
            }
          }
        </g>
      </svg>

      <!-- Overlay Controls -->
      <app-galaxy-map-settings
        [navigationMode]="!!navigationModeFleetId()"
        (exitNavigation)="exitNavigationMode()"
      >
      </app-galaxy-map-settings>

      @if (settings.showMapControls()) {
        <app-galaxy-map-controls
          (zoomIn)="state.zoomIn()"
          (zoomOut)="state.zoomOut()"
          (pan)="state.panArrow($event.x, $event.y)"
          (reset)="state.resetView()"
        ></app-galaxy-map-controls>
      }
    </section>

    <!-- Context Menus -->
    <app-planet-context-menu
      [visible]="planetContextMenu().visible"
      [x]="planetContextMenu().x"
      [y]="planetContextMenu().y"
      [star]="planetContextMenu().star"
      [selectedFleet]="selectedFleet()"
      [canSendFleet]="!!selectedFleet()"
      (close)="menus.closeMenus()"
      (viewPlanet)="menus.handleViewPlanet($event)"
      (sendFleetToStar)="menus.handleSendFleetToStar($event, state.selectedFleetId())"
    ></app-planet-context-menu>

    <app-fleet-context-menu
      [visible]="fleetContextMenu().visible"
      [x]="fleetContextMenu().x"
      [y]="fleetContextMenu().y"
      [fleet]="fleetContextMenu().fleet"
      (close)="menus.closeMenus()"
      (viewFleet)="navigation.openFleet($event)"
      (colonize)="menus.handleColonizeFleet($event)"
      (loadCargo)="menus.handleLoadCargo($event)"
      (unloadCargo)="menus.handleUnloadCargo($event)"
      (decommission)="menus.handleDecommission($event)"
    ></app-fleet-context-menu>

    <app-waypoint-context-menu
      [visible]="waypointContextMenu().visible"
      [x]="waypointContextMenu().x"
      [y]="waypointContextMenu().y"
      [canColonize]="menus.canColonizeWaypoint()"
      (close)="menus.closeMenus()"
      (delete)="menus.handleDeleteWaypoint()"
      (move)="menus.handleMoveWaypoint()"
      (setSpeed)="menus.handleWaypointSpeed()"
      (colonize)="menus.handleColonizeWaypoint()"
    ></app-waypoint-context-menu>
  } @else {
    <div style="padding: 2rem; text-align: center;">
      <p>No game active or no stars found.</p>
      <button (click)="navigation.newGame()">Start New Game</button>
    </div>
  }
</main>
