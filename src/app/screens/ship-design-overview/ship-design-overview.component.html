<main class="ship-design-screen">
  <!-- Design List Mode -->
  @if (!isDesignerMode()) {
    <div class="design-list-header">
      <h1>Ship Designs</h1>
      <button type="button" class="btn-primary" (click)="startNewDesign()">+ New Design</button>
    </div>

    <div class="designs-grid">
      <!-- Standard Designs -->
      <div class="design-card" *ngFor="let design of shipDesigns">
        <div class="design-header">
          <h3>{{ design.name }}</h3>
          <span class="design-type">{{ formatType(design) }}</span>
        </div>
        <div class="design-stats">
          <div class="stat-row">
            <span>Mass:</span>
            <span>{{ design.mass }}kt</span>
          </div>
          <div class="stat-row">
            <span>Armor:</span>
            <span>{{ design.armor }}dp</span>
          </div>
          @if (design.firepower > 0) {
            <div class="stat-row">
              <span>Firepower:</span>
              <span>{{ design.firepower }}</span>
            </div>
          }
          <div class="stat-row">
            <span>Speed:</span>
            <span>Warp {{ design.warpSpeed }}</span>
          </div>
          <div class="stat-row">
            <span>Fuel:</span>
            <span>{{ design.fuelCapacity }}mg</span>
          </div>
          @if (design.cargoCapacity > 0) {
            <div class="stat-row">
              <span>Cargo:</span>
              <span>{{ design.cargoCapacity }}kt</span>
            </div>
          }
        </div>
      </div>

      <!-- Custom Designs -->
      @for (design of customDesigns(); track design.id) {
        <div class="design-card custom">
          <div class="design-header">
            <h3>{{ design.name }}</h3>
            <span class="design-type custom">Custom</span>
          </div>
          <div class="design-actions">
            <button type="button" class="btn-small">Edit</button>
            <button type="button" class="btn-small btn-danger">Delete</button>
          </div>
        </div>
      }
    </div>
  }

  <!-- Designer Mode -->
  @if (isDesignerMode() && hull(); as currentHull) {
    <div class="designer-container">
      <!-- Header -->
      <div class="designer-header">
        <div class="design-name">
          <input
            type="text"
            [value]="design()?.name || 'New Design'"
            (change)="updateDesignName($any($event.target).value)"
            placeholder="Design Name"
          />
        </div>
        <div class="header-actions">
          <button type="button" class="btn-primary" (click)="saveDesign()" [disabled]="!stats()?.isValid">
            Save Design
          </button>
          <button type="button" (click)="cancelDesign()">Cancel</button>
        </div>
      </div>

      <div class="designer-content">
        <!-- Left: Hull Selection & Visual -->
        <div class="hull-panel">
          <!-- Hull Selector -->
          <div class="hull-selector">
            <label>Hull Type:</label>
            <select [value]="currentHull.id" (change)="selectHull($any($event.target).value)" title="Select hull type">
              @for (h of availableHulls(); track h.id) {
                <option [value]="h.id">{{ h.Name || h.name }}</option>
              }
            </select>
          </div>

          <!-- Hull Info Box (like original game) -->
          <div class="hull-info-box">
            <div class="hull-title-section">
              @if (hasHullImage(currentHull.Name || currentHull.name)) {
                <div class="hull-image-large tech-icon {{ getHullIcon(currentHull.Name || currentHull.name) }}"></div>
              } @else {
                <div class="hull-icon-large">ðŸš€</div>
              }
              <div class="hull-title-info">
                <div class="hull-title">{{ currentHull.Name || currentHull.name }}</div>
                <div class="hull-description">{{ getHullDescription(currentHull.Name || currentHull.name) }}</div>
              </div>
            </div>
            <div class="hull-stats-grid">
              <div class="hull-stat">
                <span class="label">Ironium</span>
                <span class="value">{{ currentHull.baseCost?.ironium || currentHull.Cost?.Ironium }}kt</span>
              </div>
              <div class="hull-stat">
                <span class="label">Max Fuel:</span>
                <span class="value">{{ currentHull.fuelCapacity || currentHull.Stats?.['Max Fuel'] }}mg</span>
              </div>
              <div class="hull-stat">
                <span class="label">Boranium</span>
                <span class="value">{{ currentHull.baseCost?.boranium || currentHull.Cost?.Boranium }}kt</span>
              </div>
              <div class="hull-stat">
                <span class="label">Armor:</span>
                <span class="value">{{ currentHull.armor || currentHull.Stats?.Armor }}dp</span>
              </div>
              <div class="hull-stat">
                <span class="label">Germanium</span>
                <span class="value">{{ currentHull.baseCost?.germanium || currentHull.Cost?.Germanium }}kt</span>
              </div>
              <div class="hull-stat">
                <span class="label">Mass:</span>
                <span class="value">{{ currentHull.mass || currentHull.Stats?.Mass }}kt</span>
              </div>
              @if (currentHull.cargoCapacity || currentHull.Stats?.Cargo) {
                <div class="hull-stat">
                  <span class="label">Cargo:</span>
                  <span class="value">{{ currentHull.cargoCapacity || currentHull.Stats?.Cargo }}kt</span>
                </div>
              }
            </div>
          </div>

          <!-- Hull Visual Grid (Grouped Slot System) -->
          <div class="hull-visual">
            <!-- Background Grid (Quarter Squares for Layout) -->
            <div class="hull-grid-background" 
                 [style.grid-template-columns]="'repeat(' + getGridDimensions(currentHull).cols + ', 1fr)'"
                 [style.grid-template-rows]="'repeat(' + getGridDimensions(currentHull).rows + ', 1fr)'">
              
              @for (row of getHullStructure(currentHull); track $index; let rowIndex = $index) {
                @for (cell of row; track $index; let colIndex = $index) {
                  <div class="hull-background-cell"
                       [class.empty]="cell === '.'"
                       [class.occupied]="cell !== '.'">
                  </div>
                }
              }
            </div>

            <!-- Slot Overlay (Grouped Slots) -->
            <div class="slot-overlay">
              @for (slotGroup of getSlotGroups(currentHull); track slotGroup.slotCode) {
                <div class="slot-component"
                     [class.filled]="hasComponentInSlot(slotGroup.slotCode)"
                     [class.selected]="selectedSlotId() === slotGroup.slotCode"
                     [style.grid-column]="(slotGroup.bounds.minCol + 1) + ' / ' + (slotGroup.bounds.maxCol + 2)"
                     [style.grid-row]="(slotGroup.bounds.minRow + 1) + ' / ' + (slotGroup.bounds.maxRow + 2)"
                     (click)="selectSlot(slotGroup.slotCode)">
                  
                  <div class="slot-content">
                    @if (hasComponentInSlot(slotGroup.slotCode)) {
                      <!-- Show installed component -->
                      @let installedComp = getSlotComponent(slotGroup.slotCode);
                      <div class="component-display">
                        @if (hasComponentImage(installedComp.componentId)) {
                          <div class="component-image tech-icon {{ getComponentIcon(installedComp.componentId) }}"></div>
                        } @else {
                          <div class="component-icon">{{ getSlotIcon(slotGroup.slotCode, currentHull) }}</div>
                        }
                        <div class="component-name">{{ getComponentName(installedComp.componentId) }}</div>
                        <div class="component-count">{{ installedComp.count }}</div>
                      </div>
                    } @else {
                      <!-- Show slot type -->
                      <div class="slot-icon">{{ getSlotIcon(slotGroup.slotCode, currentHull) }}</div>
                      <div class="slot-name">{{ getSlotDisplayName(slotGroup.slotCode, currentHull) }}</div>
                      <div class="slot-max">Max: {{ getSlotMaxCapacity(slotGroup.slotCode) }}</div>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        </div>



        <!-- Right: Stats -->
        @if (stats(); as compiledStats) {
          <div class="stats-panel">
            <div class="stats-box">
              <div class="stats-title">Ship Statistics</div>

              <!-- Cost -->
              <div class="stat-section">
                <div class="section-header">Cost of one {{ design()?.name }}</div>
                <div class="cost-grid">
                  <div class="cost-row">
                    <span class="cost-label ironium">Ironium</span>
                    <span class="cost-value">{{ compiledStats.cost.ironium }}kt</span>
                  </div>
                  <div class="cost-row">
                    <span class="cost-label boranium">Boranium</span>
                    <span class="cost-value">{{ compiledStats.cost.boranium }}kt</span>
                  </div>
                  <div class="cost-row">
                    <span class="cost-label germanium">Germanium</span>
                    <span class="cost-value">{{ compiledStats.cost.germanium }}kt</span>
                  </div>
                  <div class="cost-row">
                    <span class="cost-label">Mass:</span>
                    <span class="cost-value">{{ compiledStats.mass }}kt</span>
                  </div>
                </div>
              </div>

              <!-- Combat Stats -->
              @if (compiledStats.firepower > 0 || compiledStats.shields > 0) {
                <div class="stat-section">
                  <div class="section-header">Combat</div>
                  <div class="stat-list">
                    @if (compiledStats.firepower > 0) {
                      <div class="stat-item">
                        <span>Firepower:</span>
                        <span>{{ compiledStats.firepower }}</span>
                      </div>
                    }
                    <div class="stat-item">
                      <span>Armor:</span>
                      <span>{{ compiledStats.armor }}dp</span>
                    </div>
                    @if (compiledStats.shields > 0) {
                      <div class="stat-item">
                        <span>Shields:</span>
                        <span>{{ compiledStats.shields }}dp</span>
                      </div>
                    }
                    @if (compiledStats.accuracy > 0) {
                      <div class="stat-item">
                        <span>Accuracy:</span>
                        <span>{{ compiledStats.accuracy }}%</span>
                      </div>
                    }
                    @if (compiledStats.initiative > 0) {
                      <div class="stat-item">
                        <span>Initiative:</span>
                        <span>{{ compiledStats.initiative }}</span>
                      </div>
                    }
                  </div>
                </div>
              }

              <!-- Movement -->
              <div class="stat-section">
                <div class="section-header">Movement</div>
                <div class="stat-list">
                  <div class="stat-item">
                    <span>Warp Speed:</span>
                    <span>{{ compiledStats.warpSpeed > 0 ? compiledStats.warpSpeed : 'None' }}</span>
                  </div>
                  <div class="stat-item">
                    <span>Fuel Capacity:</span>
                    <span>{{ compiledStats.fuelCapacity }}mg</span>
                  </div>
                  @if (compiledStats.warpSpeed > 0) {
                    <div class="stat-item">
                      <span>Fuel Efficiency:</span>
                      <span>{{ compiledStats.fuelEfficiency === 0 ? 'Ramscoop' : compiledStats.fuelEfficiency }}</span>
                    </div>
                  }
                </div>
              </div>

              <!-- Utility -->
              @if (compiledStats.cargoCapacity > 0 || compiledStats.scanRange > 0) {
                <div class="stat-section">
                  <div class="section-header">Utility</div>
                  <div class="stat-list">
                    @if (compiledStats.cargoCapacity > 0) {
                      <div class="stat-item">
                        <span>Cargo:</span>
                        <span>{{ compiledStats.cargoCapacity }}kt</span>
                      </div>
                    }
                    @if (compiledStats.scanRange > 0) {
                      <div class="stat-item">
                        <span>Scan Range:</span>
                        <span>{{ compiledStats.scanRange }}ly</span>
                      </div>
                    }
                  </div>
                </div>
              }

              <!-- Validation -->
              @if (!compiledStats.isValid) {
                <div class="validation-error">
                  <div class="error-header">âš  Design Invalid</div>
                  @for (error of compiledStats.validationErrors; track error) {
                    <div class="error-message">{{ error }}</div>
                  }
                </div>
              } @else {
                <div class="validation-success">
                  âœ“ Design Valid
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Component Selection Modal -->
  @if (componentSelectOpen() && selectedSlot()) {
    <div class="modal-overlay" (click)="componentSelectOpen.set(false)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>
            @if (hasComponentInSlot(selectedSlotId()!)) {
              Choose How Many
            } @else {
              Select Component
            }
          </h3>
          <div class="slot-info">
            {{ getSlotTypeIcon(selectedSlot()!.allowedTypes) }}
            {{ getSlotTypeLabel(selectedSlot()!.allowedTypes) }}
          </div>
        </div>

        <!-- Current Component in Slot -->
        @if (hasComponentInSlot(selectedSlotId()!)) {
          @let currentComp = getSlotComponent(selectedSlotId()!);
          @let maxCapacity = getSlotMaxCapacity(selectedSlotId()!);
          @let component = getComponentById(currentComp.componentId);
          <div class="current-component">
            <div class="current-component-header">
              <strong>Installed:</strong>
              <button type="button" (click)="removeComponent(selectedSlotId()!)" class="btn-small btn-danger">Remove</button>
            </div>
            <div class="installed-component">
              @if (hasComponentImage(currentComp.componentId)) {
                <div class="component-image-large tech-icon {{ getComponentIcon(currentComp.componentId) }}"></div>
              } @else {
                <div class="component-icon-large">{{ getSlotTypeIcon(['general']) }}</div>
              }
              <div class="component-info">
                <div class="component-name">{{ getComponentName(currentComp.componentId) }}</div>
                <div class="component-description">{{ getComponentDescription(currentComp.componentId) }}</div>
                <div class="component-stats">
                  {{ getComponentStats(currentComp.componentId) }}
                </div>
                <div class="component-cost">
                  {{ formatComponentCost(component) }}
                </div>
                @if (maxCapacity > 1) {
                  <div class="quantity-controls">
                    <label>Quantity:</label>
                    <div class="quantity-input">
                      <button type="button" class="btn-tiny" 
                              (click)="setComponentQuantity(selectedSlotId()!, currentComp.componentId, Math.max(1, currentComp.count - 1))"
                              [disabled]="currentComp.count <= 1">-</button>
                      <span class="quantity-display">{{ currentComp.count }}</span>
                      <button type="button" class="btn-tiny"
                              (click)="setComponentQuantity(selectedSlotId()!, currentComp.componentId, Math.min(maxCapacity, currentComp.count + 1))"
                              [disabled]="currentComp.count >= maxCapacity">+</button>
                    </div>
                    <span class="max-info">Max: {{ maxCapacity }}</span>
                  </div>
                }
              </div>
            </div>
          </div>
        }

        <!-- Available Components (only show if slot is empty) -->
        @if (!hasComponentInSlot(selectedSlotId()!)) {
          <div class="component-list">
            <div class="component-list-header">Available Components:</div>
            @for (component of availableComponentsForSlot(); track component.id) {
              <div
                class="component-item"
                (click)="addComponent(component.id)"
              >
                @if (hasComponentImage(component.id)) {
                  <div class="component-image-large tech-icon {{ getComponentIcon(component.id) }}"></div>
                } @else {
                  <div class="component-icon-large">{{ getSlotTypeIcon(['general']) }}</div>
                }
                <div class="component-info">
                  <div class="component-name">{{ component.name }}</div>
                  <div class="component-description">{{ getComponentDescription(component.id) }}</div>
                  <div class="component-stats">
                    {{ getComponentStats(component.id) }}
                  </div>
                  <div class="component-details">
                    <span>Mass: {{ component.mass }}kt</span>
                    @if (component.miniaturizationLevel && component.miniaturizationLevel > 0) {
                      <span class="mini-badge">
                        -{{ ((component.baseMass - component.mass) / component.baseMass * 100).toFixed(0) }}%
                      </span>
                    }
                  </div>
                  <div class="component-cost">
                    {{ formatComponentCost(component) }}
                  </div>
                </div>
                <div class="add-button">+</div>
              </div>
            }
          </div>
        }

        <button type="button" (click)="componentSelectOpen.set(false)" class="btn-text">Close</button>
      </div>
    </div>
  }
</main>
